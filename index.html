<!DOCTYPE html>

<html>
	<head>
		<title>Voorbeeld PWA webpagina</title>
		
		<!-- Zorgen voor weergeven juiste zoom-level v/d webpagina -->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<!-- Inladen van het manifest bestand -->
		<link rel="manifest" href="manifest.json" />
		
		<!-- Service Worker registreren -->
		<script>
			window.onload = function(){
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('sw.js').then(
						registratie=> {
							console.log(`Registratie gelukt: ${registratie.scope}`);
							
							if ('PushManager' in window){
								console.log("Push berichten worden ondersteund!");
								
								/* Maken checkBox voor uberhaupt wel of geen melding
								   willen krijgen Ã³f ze berichten willen ontvangen
								   
								let jaNeePush = document.createElement("input");
								jaNeePush.setAttribute("type","checkbox");
								jaNeePush.setAttribute("id","jaNeePush");
								
								let jaNeeDiv = document.createElement("div");
								let jaNeeVraag = document.createTextNode("Push notificaties?");
								jaNeeDiv.appendChild(jaNeeVraag);
								jaNeeDiv.appendChild(jaNeePush);
								document.body.appendChild(jaNeeDiv);
								
								*/
								
								
								/* Push subscriptie checken */
								registratie.pushManager.getSubscription().then(
									sub =>{
										if (sub === null) {
											console.log("Er is nog geen geregistreerde Push-gebruiker");
											maakPushUser(registratie);
										}
									}
								)
								
							}
						}
					).catch(
						fout=> {
							console.log(`Er is iets foutgegaan: ${fout}`);
						}
					);
					
					function maakPushUser(registratie){
						//console.log(`Public key: ${applicationServerPublicKey}`);
						//const applicationServerKey = 'BGIogW4A7dzepYWHX4q9TU2j1j_KsNJRZJIx200TfvCF_6IYu6mZwJV73GazlsYoIcaxGv1lwsxc0e7p6toSq5s';
						//const applicationServerKey = base64naarUnit8Array(applicationServerPublicKey);
						
						const applicationServerKey = new Uint8Array(10);
						
						registratie.pushManager.subscribe(
							{
								userVisibleOnly: true,
								applicationServerKey: applicationServerKey
							}
						).then(
							sub => {
								updateSubscriptionAtServer(sub);
								console.log("User geabonneerd op meldingen");
							}
						).catch(
							fout => {
								console.log(`Abonneren op notificaties niet gelukt: ${fout}`);
							}
						);
					}
					
					function updateSubscriptionAtServer(subscriptie){
						/* Hier schrijven we normaal info naar de server */
						console.dir(subscriptie);
					}
					
					let BASE64_MARKER = ';base64,';

					function base64naarUnit8Array(dataURI) {
						// Gemaakt door: https://gist.github.com/borismus/1032746
						var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
						var base64 = dataURI.substring(base64Index);
						var raw = window.atob(base64);
						var rawLength = raw.length;
						var array = new Uint8Array(new ArrayBuffer(rawLength));

						for(i = 0; i < rawLength; i++) {
						array[i] = raw.charCodeAt(i);
						}
						return array;
					}
				}
			}
		</script>
	</head>
	<body>
			<header>
				<h1>Voorbeeld PWA webpagina</h1>
				<nav></nav>
			</header>
			<main>
				<article>
					<section></section>
					<section></section>
				</article>
			</main>
			<footer>
				<section></section>
			</footer>
	</body>
</html>