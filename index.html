<!DOCTYPE html>

<html>
	<head>
		<title>Voorbeeld PWA webpagina</title>
		
		<!-- Zorgen voor weergeven juiste zoom-level v/d webpagina -->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<!-- Mooie kleur balk bovenaan in de app -->
		<meta name="theme-color" content="#f3a521" />
		
		<!-- Mooi groot icoon links bovenaan in de balk van de app, PNG = OK -->
		<link rel="icon" href="images/icons/5hart.png" sizes="192x192" />
		
		<!-- Inladen van het manifest bestand -->
		<link rel="manifest" href="manifest.json" />
		
		<!-- Service Worker registreren -->
		<script>
			window.onload = function(){
			
				document.getElementById("btnGetGames").addEventListener(
					"click",
					function(ev){
						let url = 'https://bgg-json.azurewebsites.net/collection/edwalter';
						fetch(url).then(
							response => {
								return response.json();
							}
						).then(
							result => {
								result = result.map(item=>`<li>${item.name}</li>`)
									  .join('');
								document.body.innerHTML += `<ul>${result}</ul>`;
							}
						).catch(
							fout => {
								console.log(`Ging iets fout: ${fout}`);
							}
						);
					}
				);
			
			
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('sw.js').then(
						registratie=> {
							console.log(`Registratie gelukt: ${registratie.scope}`);
	
							if ('PushManager' in window){
								console.log("Push berichten worden ondersteund!");						
								
								Notification.requestPermission().then(
									antwoord => {
										if (antwoord === 'default' || antwoord === 'denied'){
											console.log('helaas; geen toestemming');
											return;
										}
									
										if (antwoord==='granted'){
											console.log('hoera!');
											// hier iets doen.
										}
									}
								);
								
								
								/* Push subscriptie checken */
								registratie.pushManager.getSubscription().then(
									sub =>{
										if (sub === null) {
											console.log("Er is nog geen geregistreerde Push-gebruiker");
											
											/* Dit gaan we pas doen zodra er een back-end server is om validatie
											   keys van te krijgen */
											   
											//maakPushUser(registratie);
										}
									}
								)
								
							}
						}
					).catch(
						fout=> {
							console.log(`Er is iets foutgegaan: ${fout}`);
						}
					);
					
					function maakPushUser(registratie){
						/* Hier krijgen we nu nog een fout, i.v.m. we dienen een key van de server te krijgen
						   omdat we nu geen server hebben draaien, kun je geen key verkrijgen en dus niet
						   valideren met de backend wie wij zijn om notificaties aan te zetten */
						   
						//const applicationServerKey = base64naarUint8Array(applicationServerPublicKey);
						
						registratie.pushManager.subscribe(
							{
								userVisibleOnly: true,
								applicationServerKey: 12345 //Uint8Array applicationServerKey
							}
						).then(
							sub => {
								updateSubscriptionAtServer(sub);
								console.log("User geabonneerd op meldingen");
							}
						).catch(
							fout => {
								console.log(`Abonneren op notificaties niet gelukt: ${fout}`);
							}
						);
					}
					
					function updateSubscriptionAtServer(subscriptie){
						/* Hier schrijven we normaal info naar de server */
						console.dir(subscriptie);
					}
					
					let BASE64_MARKER = ';base64,';

					function base64naarUint8Array(dataURI) {
						// Gemaakt door: https://gist.github.com/borismus/1032746
						var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
						var base64 = dataURI.substring(base64Index);
						var raw = window.atob(base64);
						var rawLength = raw.length;
						var array = new Uint8Array(new ArrayBuffer(rawLength));

						for(i = 0; i < rawLength; i++) {
						array[i] = raw.charCodeAt(i);
						}
						return array;
					}
				}
			}
		</script>
	</head>
	<body>
			<header>
				<h1>Voorbeeld PWA webpagina</h1>
				<nav></nav>
			</header>
			<main>
				<article>
					<section>
						<h2>Boardgames</h2>
						<div>
							<button id="btnGetGames">Haal games op</button>
						</div>
					</section>
					<section></section>
				</article>
			</main>
			<footer>
				<section></section>
			</footer>
	</body>
</html>